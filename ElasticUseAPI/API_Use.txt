As portas 5601, 8220 e 9200 são frequentemente usadas por aplicativos da Elastic Stack:

A porta 5601 é a porta padrão do Kibana, a interface web para visualização e análise de dados no Elasticsearch.
A porta 8220 é a porta padrão do Fleet Server, um componente do Elastic Stack usado para gerenciar agentes em larga escala.
A porta 9200 é a porta padrão do Elasticsearch, um mecanismo de busca distribuído e análise de dados.
É importante notar que essas portas podem ser configuradas para valores diferentes, dependendo da configuração do seu ambiente da Elastic Stack.

Podemos praticar o uso da API do Kibana em [ Dev Tools ], onde as requisições são feitas no formato [ curl ].

Para buscar os agentes iremos utilizar [ GET /.fleet-agents/_search ], onde [ .fleet-agents ] se trata do indice e [ _search ] se refere ao termo de busca fora dos metadados.

Exemplo de requisição por status do agente:

[ GET /.fleet-agents/_search?size=1&q=last_checkin_status:online ]

ou

GET /.fleet-agents/_search
{
  "size": 1,
  "query": {
    "bool": {
      "must": [
        { "match": { "last_checkin_status": "online" } }
      ]
    }
  }
}



Agora faremos uma consulta por nome:

GET /.fleet-agents/_search
{
  "size": 1,
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "local_metadata.host.hostname.keyword": {
              "value": "cpanel17.cloud"
            }
          }
        }
      ]
    }
  }
}


Agora faremos uma consulta para buscar agentes em estado [ Unenrolled ]

GET /.fleet-agents/_search
{
  "size": 1,
  "query": {
    "exists": {
      "field": "unenrolled_at"
    }
  }
}




O "bool" é uma cláusula utilizada para combinar vários critérios de pesquisa em uma única consulta, podendo incluir "must", "should" e "must_not".

O "must" é um operador booleano que especifica que os documentos correspondentes devem atender a uma determinada condição. É utilizado para adicionar uma condição obrigatória à consulta. Ou seja, um documento só será retornado se atender à condição definida no "must".

O "term" é uma consulta exata que corresponde a documentos que contêm um termo exato em um campo específico.

O "match" é uma consulta de pesquisa que analisa o texto em um campo e retorna os documentos que correspondem a um termo de pesquisa.


GET /.fleet-agents/_search
{
  "size": 10000,
  "query": {
    "bool": {
      "must": [
        {
          "exists": {
            "field": "unenrolled_at"
          }
        },
        {
          "term": {
            "local_metadata.host.hostname.keyword": {
              "value": "cpanel17.cloud"
            }
          }
        }
      ]
    }
  }
}



GET /.fleet-agents/_search
{
  "_source": ["enrolled_at", "local_metadata.host.hostname", "local_metadata.host.ip", "local_metadata.host.mac", "local_metadata.os.full", "last_checkin", "unenrolled_at", "tags"],
  "size": 200,
  "query": {
    "bool": {
      "must": [
        {
          "exists": {
            "field": "unenrolled_at"
          }
        },
        {
          "match": { 
            "last_checkin_status": "online"
          }
        }
      ]
    }
  }
}


DELETE /.fleet-agents/_doc/44ea3f4b-3103-4f48-b157-7fe01ae9ab1c